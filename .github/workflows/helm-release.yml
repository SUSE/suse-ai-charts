name: Helm Chart OCI Publisher and Github Release for each chart

on:
  push:
    branches: [ main ]
    paths:
      - '**/Chart.yaml'
      - '**/values.yaml'
      - '**/templates/**'

permissions:
  contents: write
  packages: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required for tagging and comparing history

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.15.4

      - name: Install yq
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq
          YQ_BIN="/usr/local/bin/yq"
          echo "Installing yq..."
          sudo curl -L https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -o $YQ_BIN
          sudo chmod +x $YQ_BIN

      - name: Detect changed charts
        id: detect
        run: |
          git remote set-url origin https://github.com/${{ github.repository }}.git
          git fetch origin main

          CHANGED=$(git diff --name-only origin/main...HEAD | awk -F'/' '{print $1}' | sort -u | uniq)

          if [ -z "$CHANGED" ]; then
            echo "No chart changes detected."
            echo "charts=" >> "$GITHUB_OUTPUT"
          else
            echo "Changed charts: $CHANGED"
            echo "charts=$(echo $CHANGED | tr '\n' ' ')" >> "$GITHUB_OUTPUT"
          fi

      - name: Push changed charts to OCI
        if: ${{ steps.detect.outputs.charts != '' }}
        run: |
          set -euo pipefail
          for chart in ${{ steps.detect.outputs.charts }}; do
            echo "Packaging and pushing $chart"
            cd "$chart"

            VERSION=$(yq -r '.version' Chart.yaml)
            NAME=$(yq -r '.name' Chart.yaml)
            TAG="${NAME}-${VERSION}"

            helm package .
            helm push ${NAME}-${VERSION}.tgz oci://ghcr.io/${{ github.repository_owner }}/

            echo "Pushed $NAME:$VERSION to OCI"

            echo "chart_name=$NAME" >> "$GITHUB_OUTPUT"
            echo "chart_version=$VERSION" >> "$GITHUB_OUTPUT"
            echo "chart_tag=$TAG" >> "$GITHUB_OUTPUT"
            cd ..
          done
        env:
          HELM_EXPERIMENTAL_OCI: 1

      - name: Create GitHub Release for each chart
        if: ${{ steps.detect.outputs.charts != '' }}
        run: |
          set -euo pipefail
          for chart in ${{ steps.detect.outputs.charts }}; do
            VERSION=$(yq -r '.version' $chart/Chart.yaml)
            NAME=$(yq -r '.name' $chart/Chart.yaml)
            TAG="${NAME}-${VERSION}"

            echo "Creating GitHub Release for $TAG..."

            # Only create the release if it doesn't already exist
            if gh release view "$TAG" >/dev/null 2>&1; then
              echo "Release $TAG already exists. Skipping."
            else
              gh release create "$TAG" \
                --title "$NAME $VERSION" \
                --notes "Release for Helm chart **$NAME**, version **$VERSION**" \
                "$chart/${NAME}-${VERSION}.tgz"
              echo "Created GitHub release $TAG"
            fi
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
